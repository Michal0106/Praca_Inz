generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String           @id @default(uuid())
  email                String           @unique
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  stravaId             String?          @unique
  firstName            String?
  lastName             String?
  password             String
  stravaAccessToken    String?
  stravaRefreshToken   String?
  stravaTokenExpiresAt DateTime?
  achievements         Achievement[]
  activities           Activity[]
  fitnessMetrics       FitnessMetrics[]
  refreshTokens        RefreshToken[]
  userStats            UserStats?
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Activity {
  id               String           @id @default(uuid())
  userId           String
  externalId       String
  source           DataSource
  name             String
  type             String
  startDate        DateTime
  duration         Int
  distance         Float?
  averageHeartRate Int?
  maxHeartRate     Int?
  averageSpeed     Float?
  maxSpeed         Float?
  elevationGain    Float?
  calories         Int?
  averagePower     Int?
  maxPower         Int?
  trainingLoad     Float?
  intensity        String?
  createdAt        DateTime         @default(now())
  intensityFactor  Float?
  normalizedPower  Int?
  pacePerKm        Json?            @db.Json
  tss              Float?
  bestEfforts      Json?            @db.Json
  laps             Json?            @db.Json
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  cluster          ActivityCluster?
  gpsPoints        GpsPoint[]
  paceDistance     PaceDistance?
  powerCurve       PowerCurve?
  segmentEfforts   SegmentEffort[]

  @@unique([externalId, source])
  @@index([userId])
  @@index([startDate])
}

model GpsPoint {
  id         String   @id @default(uuid())
  activityId String
  latitude   Float
  longitude  Float
  altitude   Float?
  timestamp  DateTime
  speed      Float?
  heartRate  Int?
  power      Int?
  cadence    Int?
  activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@index([activityId])
  @@index([timestamp])
}

model PowerCurve {
  id         String   @id @default(uuid())
  activityId String   @unique
  userId     String
  sec5       Float?
  sec30      Float?
  min1       Float?
  min2       Float?
  min5       Float?
  min10      Float?
  min20      Float?
  min60      Float?
  type       String
  createdAt  DateTime @default(now())
  activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model FitnessMetrics {
  id        String   @id @default(uuid())
  userId    String
  date      DateTime
  ctl       Float
  atl       Float
  tsb       Float
  rampRate  Float?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

model ActivityCluster {
  id         String   @id @default(uuid())
  userId     String
  activityId String   @unique
  cluster    Int
  pca1       Float
  pca2       Float
  features   Json
  createdAt  DateTime @default(now())
  activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([cluster])
}

model Segment {
  id         String          @id @default(uuid())
  externalId String          @unique
  name       String
  distance   Float
  avgGrade   Float?
  startLat   Float
  startLng   Float
  endLat     Float
  endLng     Float
  createdAt  DateTime        @default(now())
  efforts    SegmentEffort[]
}

model SegmentEffort {
  id          String   @id @default(uuid())
  segmentId   String
  activityId  String
  userId      String
  elapsedTime Int
  movingTime  Int
  startDate   DateTime
  avgPower    Int?
  avgHr       Int?
  isPr        Boolean  @default(false)
  createdAt   DateTime @default(now())
  activity    Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  segment     Segment  @relation(fields: [segmentId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([segmentId])
  @@index([startDate])
}

model UserStats {
  id                 String    @id @default(uuid())
  userId             String    @unique
  totalActivities    Int       @default(0)
  totalDistance      Float     @default(0)
  totalDuration      Int       @default(0)
  totalElevationGain Float     @default(0)
  averageIntensity   Float?
  longestActivityId  String?
  lastSyncDate       DateTime?
  updatedAt          DateTime  @updatedAt
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model TrainingPlanTemplate {
  id          String         @id @default(uuid())
  name        String
  description String
  level       Level
  weeklyHours Int
  daysPerWeek Int
  focusType   FocusType
  duration    Int
  createdAt   DateTime       @default(now())
  weeks       TrainingWeek[]

  @@index([level])
  @@index([focusType])
}

model TrainingWeek {
  id         String               @id @default(uuid())
  templateId String
  weekNumber Int
  sessions   TrainingSession[]
  template   TrainingPlanTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, weekNumber])
}

model TrainingSession {
  id          String       @id @default(uuid())
  weekId      String
  dayOfWeek   Int
  sessionType String
  duration    Int
  intensity   String
  description String
  week        TrainingWeek @relation(fields: [weekId], references: [id], onDelete: Cascade)
}

model PaceDistance {
  id         String   @id @default(uuid())
  activityId String   @unique
  userId     String
  km1        Float?
  km5        Float?
  km10       Float?
  km21       Float?
  km42       Float?
  createdAt  DateTime @default(now())
  activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model Achievement {
  id           String    @id @default(uuid())
  userId       String
  type         String
  name         String
  description  String
  category     String
  earned       Boolean   @default(false)
  earnedDate   DateTime?
  progress     Float     @default(0)
  targetValue  Float?
  currentValue Float?
  icon         String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([earned])
}

enum DataSource {
  STRAVA
  GARMIN
}

enum Level {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  ELITE
}

enum FocusType {
  ENDURANCE
  STRENGTH
  SPEED
  MIXED
  RECOVERY
}
